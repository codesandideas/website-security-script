scan_section_1() {
    local REPORT_FILE="$1"
    # ══════════════════════════════════════════════════════════════════════════════
    # SECTION 1: MALWARE & BACKDOOR DETECTION
    # ══════════════════════════════════════════════════════════════════════════════
    log "Scanning for malware signatures & backdoors..."

    cat >> "$REPORT_FILE" <<'EOF'
## 1. Malware & Backdoor Detection

Scanning for known malware patterns, web shells, backdoors, and malicious code injections.

EOF

    # ── 1a. Known Web Shells ─────────────────────────────────────────────────────
    WEBSHELL_PATTERNS=(
        'r57shell' 'c99shell' 'c100.php' 'WSO\s' 'b374k' 'FilesMan'
        'ALFA_DATA' 'alfashell' 'Meterpreter' 'phpspy' 'GIF89a.*<\?php'
        'AnonymousFox' 'IndoXploit' 'FLAVIOPEREIRA' 'marlboro' 'k2ll33d'
        'Dx2023' 'DEVELOPER FLAVOR' 'web.*shell' 'php.*shell.*tool'
        'Weevely' 'China\s*Chopper' 'ice.*scorpion' 'behinder'
        'godzilla.*shell' 'JspSpy' 'AntSword'
    )
    WEBSHELL_REGEX=$(IFS='|'; echo "${WEBSHELL_PATTERNS[*]}")

    WEBSHELL_RESULTS=$(grep -rlEi "$WEBSHELL_REGEX" "$SCAN_DIR" \
        --include="*.php" --include="*.php5" --include="*.phtml" --include="*.pht" \
        --include="*.suspected" --include="*.jsp" --include="*.jspx" \
        --include="*.asp" --include="*.aspx" \
        2>/dev/null | grep -v "node_modules\|vendor/\|\.git/" | head -50 || true)

    if [[ -n "$WEBSHELL_RESULTS" ]]; then
        finding "critical" "Known Web Shell Signatures Detected" \
            "Files matching known web shell signatures were found. These are almost certainly malicious." \
            "$WEBSHELL_RESULTS" \
            "Immediately quarantine or delete these files. Investigate how they were uploaded."
    else
        echo "✅ No known web shell signatures found." >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
    fi

    # ── 1b. PHP Backdoor Functions ──────────────────────────────────────────────
    if $HAS_PHP; then
        log "Checking for PHP backdoor patterns..."

        BACKDOOR_PATTERNS=(
            'eval\s*\(\s*\$_(GET|POST|REQUEST|COOKIE|SERVER)'
            'eval\s*\(\s*base64_decode'
            'eval\s*\(\s*gzinflate'
            'eval\s*\(\s*gzuncompress'
            'eval\s*\(\s*str_rot13'
            'assert\s*\(\s*\$_(GET|POST|REQUEST|COOKIE)'
            'preg_replace\s*\(.*\/e\s*["\x27]'
            'create_function\s*\('
            'call_user_func\s*\(\s*\$_(GET|POST|REQUEST)'
            'array_map\s*\(\s*\$_(GET|POST|REQUEST)'
            'array_filter\s*\(\s*\$_(GET|POST|REQUEST)'
            'usort\s*\(.*\$_(GET|POST|REQUEST)'
            '\$\w+\s*=\s*\$_(GET|POST|REQUEST|COOKIE)\[.*\]\s*;\s*@?\$\w+\s*\('
            'passthru\s*\(\s*\$_(GET|POST|REQUEST)'
            'shell_exec\s*\(\s*\$_(GET|POST|REQUEST)'
            'system\s*\(\s*\$_(GET|POST|REQUEST)'
            'exec\s*\(\s*\$_(GET|POST|REQUEST)'
            'popen\s*\(\s*\$_(GET|POST|REQUEST)'
            'proc_open\s*\(\s*\$_(GET|POST|REQUEST)'
            'pcntl_exec\s*\('
            'file_put_contents\s*\(.*\$_(GET|POST|REQUEST)'
            'fwrite\s*\(.*\$_(GET|POST|REQUEST)'
        )

        BACKDOOR_REGEX=$(IFS='|'; echo "${BACKDOOR_PATTERNS[*]}")
        BACKDOOR_RESULTS=$(grep -rnEi "$BACKDOOR_REGEX" "$SCAN_DIR" \
            --include="*.php" --include="*.php5" --include="*.phtml" --include="*.inc" \
            2>/dev/null | grep -v "node_modules\|vendor/" | head -100 || true)

        if [[ -n "$BACKDOOR_RESULTS" ]]; then
            finding "critical" "PHP Backdoor Function Patterns Detected" \
                "Code patterns commonly used in PHP backdoors were found, allowing remote code execution." \
                "$BACKDOOR_RESULTS" \
                "Review each file carefully. Remove any that contain backdoor code."
        else
            echo "✅ No PHP backdoor patterns found." >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
        fi
    fi

    # ── 1c. Python Backdoor / Reverse Shell Patterns ────────────────────────────
    if $HAS_PYTHON; then
        log "Checking for Python backdoor patterns..."

        PY_BACKDOOR_PATTERNS=(
            'import\s+subprocess.*shell\s*=\s*True'
            'os\.system\s*\(.*request\.'
            'os\.popen\s*\(.*request\.'
            'subprocess\.call\s*\(.*request\.'
            'exec\s*\(\s*request\.(GET|POST|args|form|data)'
            'eval\s*\(\s*request\.(GET|POST|args|form|data)'
            '__import__\s*\(\s*["\x27]os["\x27]\s*\)\.system'
            'socket\.socket.*connect\s*\('
            'pty\.spawn'
            'pickle\.loads\s*\(.*request'
            'yaml\.load\s*\(.*request'
            'marshal\.loads'
        )

        PY_BACKDOOR_REGEX=$(IFS='|'; echo "${PY_BACKDOOR_PATTERNS[*]}")
        PY_RESULTS=$(grep -rnEi "$PY_BACKDOOR_REGEX" "$SCAN_DIR" \
            --include="*.py" 2>/dev/null | grep -v "node_modules\|venv/\|\.git/\|__pycache__" | head -50 || true)

        if [[ -n "$PY_RESULTS" ]]; then
            finding "critical" "Python Backdoor / Reverse Shell Patterns" \
                "Dangerous Python code patterns were found that could allow remote code execution." \
                "$PY_RESULTS" \
                "Review these files. Patterns like eval(request.data) or os.system(request.args) are critical vulnerabilities."
        else
            echo "✅ No Python backdoor patterns found." >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
        fi
    fi

    # ── 1d. Node.js Backdoor Patterns ───────────────────────────────────────────
    if $HAS_JS; then
        log "Checking for Node.js backdoor patterns..."

        JS_BACKDOOR_PATTERNS=(
            'child_process.*exec\s*\(\s*req\.(body|query|params)'
            'child_process.*spawn\s*\(\s*req\.(body|query|params)'
            'eval\s*\(\s*req\.(body|query|params)'
            'new\s+Function\s*\(\s*req\.(body|query|params)'
            'vm\.runInNewContext\s*\(.*req\.'
            'require\s*\(\s*["\x27]child_process["\x27]\s*\).*exec\s*\(\s*req'
            'process\.binding\s*\('
            'Buffer\.from\s*\(.*["\x27]base64["\x27]\s*\).*eval'
        )

        JS_BACKDOOR_REGEX=$(IFS='|'; echo "${JS_BACKDOOR_PATTERNS[*]}")
        JS_RESULTS=$(grep -rnEi "$JS_BACKDOOR_REGEX" "$SCAN_DIR" \
            --include="*.js" --include="*.mjs" --include="*.ts" \
            2>/dev/null | grep -v "node_modules\|\.next/\|dist/\|build/" | head -50 || true)

        if [[ -n "$JS_RESULTS" ]]; then
            finding "critical" "Node.js Backdoor / Command Injection Patterns" \
                "Dangerous Node.js code patterns were found that could allow remote code execution." \
                "$JS_RESULTS" \
                "Never pass user input directly to child_process, eval(), or new Function(). Sanitize all inputs."
        else
            echo "✅ No Node.js backdoor patterns found." >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
        fi
    fi

    # ── 1e. Malicious Iframes & Script Injections (universal) ───────────────────
    log "Checking for malicious iframes & injections..."

    INJECT_PATTERNS=(
        '<iframe[^>]*style\s*=\s*["\x27][^"]*display\s*:\s*none'
        '<iframe[^>]*width\s*=\s*["\x270]["\x27]'
        '<iframe[^>]*height\s*=\s*["\x270]["\x27]'
        '<script[^>]*src\s*=\s*["\x27]https?://[^/]*\.(xyz|tk|ml|ga|cf|top|buzz|click|gq)/'
        'document\.write\s*\(\s*unescape'
        'document\.write\s*\(\s*String\.fromCharCode'
        'eval\s*\(\s*function\s*\(\s*p\s*,\s*a\s*,\s*c\s*,\s*k'
        '<script[^>]*>.*var\s+_0x[a-f0-9]+'
        'onmouseover\s*=\s*["\x27]\s*eval'
        'onerror\s*=\s*["\x27]\s*eval'
    )

    INJECT_REGEX=$(IFS='|'; echo "${INJECT_PATTERNS[*]}")
    INJECT_RESULTS=$(grep -rnEi "$INJECT_REGEX" "$SCAN_DIR" \
        --include="*.php" --include="*.html" --include="*.htm" --include="*.js" \
        --include="*.tpl" --include="*.blade.php" --include="*.twig" --include="*.ejs" \
        --include="*.pug" --include="*.hbs" --include="*.erb" --include="*.jinja2" \
        2>/dev/null | grep -v "node_modules\|vendor/\|\.git/" | head -50 || true)

    if [[ -n "$INJECT_RESULTS" ]]; then
        finding "high" "Malicious Script Injections / Hidden Iframes" \
            "Hidden iframes or suspicious script injections were found." \
            "$INJECT_RESULTS" \
            "Remove injected code. Investigate the entry point — often a compromised plugin, dependency, or stolen credentials."
    else
        echo "✅ No malicious iframe or script injections found." >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
    fi

    # ── 1f. Crypto Miners ───────────────────────────────────────────────────────
    log "Checking for cryptocurrency miners..."

    MINER_PATTERNS=(
        'coinhive' 'CoinImp' 'cryptonight' 'coin-hive' 'jsecoin'
        'cryptoloot' 'minero\.cc' 'webminepool' 'miner\.start'
        'stratum\+tcp' 'MoneroOcean'
    )
    MINER_REGEX=$(IFS='|'; echo "${MINER_PATTERNS[*]}")
    MINER_RESULTS=$(grep -rlEi "$MINER_REGEX" "$SCAN_DIR" \
        --include="*.php" --include="*.js" --include="*.html" --include="*.py" --include="*.rb" \
        2>/dev/null | grep -v "node_modules\|vendor/" | head -20 || true)

    if [[ -n "$MINER_RESULTS" ]]; then
        finding "critical" "Cryptocurrency Miner Detected" \
            "Files referencing known cryptocurrency mining scripts were found." \
            "$MINER_RESULTS" \
            "Remove the mining code immediately. This hijacks visitors' CPU resources."
    else
        echo "✅ No cryptocurrency miners found." >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
    fi

    # ── 1g. SEO Spam / Pharma Hack ──────────────────────────────────────────────
    log "Checking for SEO spam / pharma hacks..."

    SPAM_PATTERNS=(
        'viagra|cialis|levitra|kamagra'
        'buy.*cheap.*online'
        'poker.*online.*casino'
        'display:none.*<a.*href'
        'position:absolute.*left:-[0-9]{4,}'
        'cloaking.*googlebot'
    )
    SPAM_REGEX=$(IFS='|'; echo "${SPAM_PATTERNS[*]}")
    SPAM_RESULTS=$(grep -rlEi "$SPAM_REGEX" "$SCAN_DIR" \
        --include="*.php" --include="*.html" --include="*.htm" --include="*.tpl" \
        --include="*.blade.php" --include="*.twig" --include="*.erb" \
        2>/dev/null | grep -v "node_modules\|vendor/\|\.git/" | head -30 || true)

    if [[ -n "$SPAM_RESULTS" ]]; then
        finding "high" "SEO Spam / Pharma Hack Indicators" \
            "Files containing pharmaceutical spam or SEO injection patterns were found." \
            "$SPAM_RESULTS" \
            "Clean injected content and investigate the entry point."
    else
        echo "✅ No SEO spam indicators found." >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
    fi


}
